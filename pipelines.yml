trigger:
- main

pool:
  name: 'New-pool'   # <-- replace with your self-hosted agent pool name

variables:
  acrName: 'azanacr'
  acrLoginServer: 'azanacr-f7eabjd2gsczcke4.azurecr.io'
  imageName: 'nodeapp'
  tag: $(Build.BuildId)

stages:
- stage: Build
  jobs:
  - job: BuildAndPush
    steps:
    - script: |
        echo "Logging in to ACR..."
        docker login $(acrLoginServer) -u $(acrName) -p $(acrPassword)

        echo "Building Docker image..."
        docker build -t $(acrLoginServer)/$(imageName):$(tag) .
        docker tag $(acrLoginServer)/$(imageName):$(tag) $(acrLoginServer)/$(imageName):latest

        echo "Pushing images to ACR..."
        docker push $(acrLoginServer)/$(imageName):$(tag)
        docker push $(acrLoginServer)/$(imageName):latest
      displayName: "Build & Push Docker Image"

- stage: Deploy
  dependsOn: Build
  jobs:
  - job: DeployToVM
    steps:
    - script: |
        echo "Logging in to ACR..."
        docker login $(acrLoginServer) -u $(acrName) -p $(acrPassword)

        echo "Deploying app with Docker Compose..."
        export TAG=$(tag)
        cd ~/my-node-app
        docker-compose pull
        docker-compose up -d
      displayName: "Deploy with Docker Compose"
